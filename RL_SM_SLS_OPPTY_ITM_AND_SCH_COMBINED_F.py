
#
# RL_SM_SLS_OPPTY_ITM_AND_SCH_COMBINED_F.py
#

import os
import json
import io
import sys
from datetime import datetime
from pyspark.sql import SparkSession, DataFrame, Row, SQLContext
from pyspark import SparkContext
from pyspark.sql.window import Window
import pyspark.sql.types as T
import pyspark.sql.functions as F

def fetch_schema_name(stmt_id, spark_session, schema_name):
    print("fetching schema name for {schema_name}".format(schema_name=schema_name))
    ret_val = None
    try:
        df = spark_session.sql("select param_value from edw_control.param_env where param_nm = '{schema_name}';".format(schema_name=schema_name))
        if df.count() > 0:
            df.show(10, False)
            data = df.collect()
            #print(data)
            ret_val_list = [ row.param_value for row in data ]
            #print(ret_val_list)
            ret_val = ret_val_list[0]
            print("param value for {schema_name} -- {ret_val}".format(schema_name=schema_name, ret_val=ret_val))
        else:
            ret_val = None
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = None
    return ret_val

def fetch_param_value(stmt_id, spark_session, param_name):
    print("fetching value for {param_name}".format(param_name=param_name))
    ret_val = None
    try:
        query_string="""
        select concat('Select ', column_nm, ' as ', param_nm, ' from ', table_nm, ' ', clause, ';' )
        from edw_control.param_mapping
        where param_nm = '{param_name}';
        """.format(param_name=param_name)
        df = spark_session.sql(query_string)
        if df.count() > 0:
            df.show(10, False)
            data = df.collect()
            q_list = [ row[0] for row in data ]
            q = q_list[0]
            df2 = spark_session.sql(q)
            if df2.count() > 0:
                df2.show(10, False)
                data2 = df2.collect()
                r_list = [ row[0] for row in data2 ]
                ret_val = r_list[0]
                print("param value for {param_name} -- {ret_val}".format(param_name=param_name, ret_val=ret_val))
            else:
                ret_val = None
        else:
            ret_val = None
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = None
    return ret_val

def execute_sql(stmt_id, spark_session, spark_context, sql_context, query_string):
    print("executing {stmt_id} - {query_string}".format(stmt_id=stmt_id, query_string=query_string))
    ret_val = False
    try:
        spark_session.sql(query_string)
        ret_val = True
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = False
    return ret_val

def execute():
    spark_session = (SparkSession.builder
        .config("spark.sql.extensions", "io.delta.sql.DeltaSparkSessionExtension")
        .getOrCreate()
    )
    spark_context = spark_session.sparkContext
    sql_context = SQLContext(spark_context)

    PARAM_SCHEMA_ETL_SCHEMA_s = fetch_schema_name("1", spark_session, "ETL_SCHEMA")
    if PARAM_SCHEMA_ETL_SCHEMA_s is None:
        print("ERROR fetching value for parameter 'PARAM_SCHEMA_ETL_SCHEMA_s'")
        sys.exit(1)
    query_to_execute = """USE {PARAM_SCHEMA_ETL_SCHEMA_s};""".format(PARAM_SCHEMA_ETL_SCHEMA_s=PARAM_SCHEMA_ETL_SCHEMA_s)
    ret_val = execute_sql("1", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(1)

    query_to_execute = """DELETE FROM SLS_OPPTY_ITM_AND_SCH_COMBINED_F ;""" 
    ret_val = execute_sql("2", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(2)

    PARAM_BATCH_ID_s = fetch_param_value("4", spark_session, "PARAM_BATCH_ID_s")
    if PARAM_BATCH_ID_s is None:
        print("ERROR fetching value for parameter 'PARAM_BATCH_ID_s'")
        sys.exit(3)
    PARAM_BATCH_GMT_START_TS_s = fetch_param_value("4", spark_session, "PARAM_BATCH_GMT_START_TS_s")
    if PARAM_BATCH_GMT_START_TS_s is None:
        print("ERROR fetching value for parameter 'PARAM_BATCH_GMT_START_TS_s'")
        sys.exit(3)
    #query_to_execute = """INSERT INTO SLS_OPPTY_ITM_AND_SCH_COMBINED_F SELECT SIS.SPRN_CO_ID,SIS.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID,SIS.SLS_OPPTY_ITM_NR,SIS.SLS_OPPTY_ITM_SCH_ITM_NR,SIS.SLS_OPPTY_ID,SIS.BUS_AREA_GRP_ID AS BUS_AREA_GRP_ID,SIS.SLS_OPPTY_ITM_SCH_TYPE_CD,SIT.SLS_OPPTY_ITM_SCH_TYPE_NM,SIS.RANDOM_DEAL_ID,SIS.DSTNCT_DEAL_CT_NR,SIS.SLS_OPPTY_QTD_MRGN_FAC_NR,SIS.ACCT_HIST_MRGN_FAC_NR,SIS.CTRY_PROXY_MRGN_FAC_NR,SIS.PROJED_SLS_OPPTY_MRGN_FAC_NR,SIS.CRNCY_CD,SIS.QTD_MRGN_FAC_PROD_LVL_CD,SIS.QTD_MRGN_FAC_PROD_LVL_EXT_CD,SIS.ACCT_HIST_MRGN_FAC_PROD_LVL_CD,SIS.ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_LVL_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_SRC_CD,SIS.SLS_OPPTY_ITM_NM,SIS.SLS_OPPTY_ITM_DN,SIS.SLS_OPPTY_ITM_QT_SCH_IND,SIS.SLS_OPPTY_ITM_DRCT_IND,SIS.SLS_OPPTY_ITM_ATTACH_IND,SIS.SLS_OPPTY_ITM_WIN_BCK_IND,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_IND,SIS.SLS_OPPTY_ITM_INTRA_CO_OEM_IND,CAST(SIS.SLS_OPPTY_ITM_REQD_DLVR_TS AS DATE),CAST(SIS.SLS_OPPTY_ITM_SCH_ESTMT_DLVR_TS AS DATE),CAST(SIS.SLS_OPPTY_ITM_QTN_TURNRND_TM_GOAL_TS AS DATE),CAST(SIS.SLS_OPPTY_ITM_SRVCS_STRT_TS AS DATE),CAST(SIS.SLS_OPPTY_ITM_SRVCS_END_TS AS DATE),SIS.SLS_OPPTY_ITM_MRGN_PC,SIS.SLS_OPPTY_ITM_ENTPRS_QT,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_QT,SIS.SLS_OPPTY_ITM_ENTPRS_LIST_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_SLS_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_TOT_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_QTD_BILLD_NET_REV_USD_AM,SIS.SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.ACCT_HIST_NET_REV_USD_AM,SIS.ACCT_HIST_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_LIST_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_SLS_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_TOT_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_LC_AM,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_USD_AM,SIS.SRC_SYS_KY,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS INS_GMT_TS,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS UPD_GMT_TS,{PARAM_BATCH_ID_s} AS LOAD_JOB_NR,(CASE WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '1') THEN BAPI.BUS_GRP_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '2') THEN BAPI.GBL_BUS_UNIT_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '3') THEN BAPI.BUS_AREA_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '4') THEN BAPI.BUS_SUB_AREA_CD ELSE '?' END) AS PROD_MLTGRN_CD,SO.ACT_SOLN_OPPTY_APPV_REVW_ID,ST.SLS_OPPTY_TYPE_CD,ST.SLS_OPPTY_TYPE_NM,SDC.SLS_OPPTY_DEAL_CHKLIST_CD,SDC.SLS_OPPTY_DEAL_CHKLIST_NM,SS.SLS_OPPTY_SLS_STAGE_CD,SS.SLS_OPPTY_SLS_STAGE_NM,SOFC.SLS_OPPTY_FCST_CATG_CD,SOFC.SLS_OPPTY_FCST_CATG_NM,SST.SLS_OPPTY_STAT_CD,SST.SLS_OPPTY_STAT_NM,SR.SLS_OPPTY_RSPY_CD,SR.SLS_OPPTY_RSPY_NM,ES.ENTPRS_SOLN_CD,ES.ENTPRS_SOLN_NM,(CASE WHEN (CT.CNFDTL_TYPE_NM = 'TRUE') THEN 'Y' WHEN (CT.CNFDTL_TYPE_NM = 'FALSE') THEN 'N' ELSE 'N' END) AS CNFDTL_TYPE_CD,CT.CNFDTL_TYPE_NM,SPT.SLS_OPPTY_PRCS_TYPE_CD,SPT.SLS_OPPTY_PRCS_TYPE_NM,FT.FIN_SRVC_FIN_TYPE_CD,FT.FIN_SRVC_FIN_TYPE_NM,LT.FIN_SRVC_LEASE_TYPE_CD,LT.FIN_SRVC_LEASE_TYPE_NM,SRT.SLS_OPPTY_RENEW_TYPE_CD,SRT.SLS_OPPTY_RENEW_TYPE_NM,SO.ERLIEST_ESTMT_DLVR_DT,SO.ERLIEST_SRVCS_STRT_DT,SO.SLS_OPPTY_CLOSE_DT,SIS.SLS_OPPTY_ITM_PROD_MDL_CATG_CD,MDL_CGY.SLS_OPTY_ITM_PROD_MDL_CGY_NM AS SLS_OPPTY_ITM_PROD_MDL_CATG_NM,SIS.SLS_OPPTY_ITM_SCOPE_CD,SCP.SLS_OPTY_ITM_SCP_NM AS SLS_OPPTY_ITM_SCP_NM FROM SLS_OPPTY_ITM_AND_SCH_F SIS LEFT OUTER JOIN SLS_OPPTY_ITM_SCH_TYPE_D SIT ON SIS.SPRN_CO_ID = SIT.SPRN_CO_ID AND SIS.SLS_OPPTY_ITM_SCH_TYPE_CD = SIT.SLS_OPPTY_ITM_SCH_TYPE_CD LEFT OUTER JOIN '(select sprn_co_id, bus_area_grp_id, max(BUS_GRP_CD)''BUS_GRP_CD''' max(BUS_AREA_CD) ''BUS_AREA_CD'' 'max(BUS_AREA_HIER_LVL_CLS_CD)''BUS_AREA_HIER_LVL_CLS_CD' FROM BUS_AREA_GRP_ITM_D GROUP BY 1 ON SIS.SPRN_CO_ID = BAPI.SPRN_CO_ID AND SIS.BUS_AREA_GRP_ID = BAPI.BUS_AREA_GRP_ID LEFT OUTER JOIN SLS_OPPTY_F SO ON SIS.SPRN_CO_ID = SO.SPRN_CO_ID AND SIS.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID = SO.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID LEFT OUTER JOIN SLS_OPPTY_FCST_CATG_D SOFC ON SO.SPRN_CO_ID = SOFC.SPRN_CO_ID AND SO.SLS_OPPTY_FCST_CATG_CD = SOFC.SLS_OPPTY_FCST_CATG_CD LEFT OUTER JOIN SLS_OPPTY_TYPE_D ST ON SO.SPRN_CO_ID = ST.SPRN_CO_ID AND SO.SLS_OPPTY_TYPE_CD = ST.SLS_OPPTY_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_DEAL_CHKLIST_D SDC ON SO.SPRN_CO_ID = SDC.SPRN_CO_ID AND SO.SLS_OPPTY_DEAL_CHKLIST_CD = SDC.SLS_OPPTY_DEAL_CHKLIST_CD LEFT OUTER JOIN SLS_OPPTY_SLS_STAGE_D SS ON SO.SPRN_CO_ID = SS.SPRN_CO_ID AND SO.SLS_OPPTY_SLS_STAGE_CD = SS.SLS_OPPTY_SLS_STAGE_CD LEFT OUTER JOIN SLS_OPPTY_STAT_D SST ON SO.SPRN_CO_ID = SST.SPRN_CO_ID AND SO.SLS_OPPTY_STAT_CD = SST.SLS_OPPTY_STAT_CD LEFT OUTER JOIN SLS_OPPTY_RSPY_D SR ON SO.SPRN_CO_ID = SR.SPRN_CO_ID AND SO.SLS_OPPTY_RSPY_CD = SR.SLS_OPPTY_RSPY_CD LEFT OUTER JOIN ENTPRS_SOLN_D ES ON SO.SPRN_CO_ID = ES.SPRN_CO_ID AND SO.ENTPRS_SOLN_CD = ES.ENTPRS_SOLN_CD LEFT OUTER JOIN CNFDTL_TYPE_D CT ON SO.SPRN_CO_ID = CT.SPRN_CO_ID AND SO.CNFDTL_TYPE_CD = CT.CNFDTL_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_PRCS_TYPE_D SPT ON SO.SPRN_CO_ID = SPT.SPRN_CO_ID AND SO.SLS_OPPTY_PRCS_TYPE_CD = SPT.SLS_OPPTY_PRCS_TYPE_CD LEFT OUTER JOIN FIN_SRVC_FIN_TYPE_D FT ON SO.SPRN_CO_ID = FT.SPRN_CO_ID AND SO.FIN_SRVC_FIN_TYPE_CD = FT.FIN_SRVC_FIN_TYPE_CD LEFT OUTER JOIN FIN_SRVC_LEASE_TYPE_D LT ON SO.SPRN_CO_ID = LT.SPRN_CO_ID AND SO.FIN_SRVC_LEASE_TYPE_CD = LT.FIN_SRVC_LEASE_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_RENEW_TYPE_D SRT ON SO.SPRN_CO_ID = SRT.SPRN_CO_ID AND SO.SLS_OPPTY_RENEW_TYPE_CD = SRT.SLS_OPPTY_RENEW_TYPE_CD LEFT OUTER JOIN SLS_OPTY_ITM_PROD_MDL_CGY MDL_CGY ON SIS.SRC_SYS_KY = MDL_CGY.SRC_SYS_KY AND SIS.SLS_OPPTY_ITM_PROD_MDL_CATG_CD = MDL_CGY.SLS_OPTY_ITM_PROD_MDL_CGY_CD AND MDL_CGY.DLT_IND = 'N' LEFT OUTER JOIN SLS_OPTY_ITM_SCP SCP ON SIS.SRC_SYS_KY = SCP.SRC_SYS_KY AND SIS.SLS_OPPTY_ITM_SCOPE_CD = SCP.SLS_OPTY_ITM_SCP_CD AND SCP.DLT_IND = 'N' ;""".format(PARAM_BATCH_ID_s=PARAM_BATCH_ID_s, PARAM_BATCH_GMT_START_TS_s=PARAM_BATCH_GMT_START_TS_s)
    
    query_to_execute = """INSERT INTO SLS_OPPTY_ITM_AND_SCH_COMBINED_F SELECT SIS.SPRN_CO_ID AS SPRN_CO_ID,SIS.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID AS SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID,SIS.SLS_OPPTY_ITM_NR AS SLS_OPPTY_ITM_NR,SIS.SLS_OPPTY_ITM_SCH_ITM_NR AS SLS_OPPTY_ITM_SCH_ITM_NR,SIS.SLS_OPPTY_ID AS SLS_OPPTY_ID,SIS.SLS_OPPTY_ITM_SCH_TYPE_CD AS SLS_OPPTY_ITM_SCH_TYPE_CD,SIT.SLS_OPPTY_ITM_SCH_TYPE_NM AS SLS_OPPTY_ITM_SCH_TYPE_NM,SIS.RANDOM_DEAL_ID AS RANDOM_DEAL_ID,SIS.DSTNCT_DEAL_CT_NR AS DSTNCT_DEAL_CT_NR,SIS.SLS_OPPTY_QTD_MRGN_FAC_NR AS SLS_OPPTY_QTD_MRGN_FAC_NR,SIS.ACCT_HIST_MRGN_FAC_NR AS ACCT_HIST_MRGN_FAC_NR,SIS.CTRY_PROXY_MRGN_FAC_NR AS CTRY_PROXY_MRGN_FAC_NR,SIS.PROJED_SLS_OPPTY_MRGN_FAC_NR AS PROJED_SLS_OPPTY_MRGN_FAC_NR,SIS.CRNCY_CD AS CRNCY_CD,SIS.QTD_MRGN_FAC_PROD_LVL_CD AS QTD_MRGN_FAC_PROD_LVL_CD,SIS.QTD_MRGN_FAC_PROD_LVL_EXT_CD AS QTD_MRGN_FAC_PROD_LVL_EXT_CD,SIS.ACCT_HIST_MRGN_FAC_PROD_LVL_CD AS ACCT_HIST_MRGN_FAC_PROD_LVL_CD,SIS.ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD AS ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD AS CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_LVL_CD AS CTRY_PROXY_MRGN_FAC_PROD_LVL_CD,SIS.CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD AS CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_CD AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD,SIS.PROJED_SLS_OPPTY_MRGN_FAC_SRC_CD AS PROJED_SLS_OPPTY_MRGN_FAC_SRC_CD,SIS.SLS_OPPTY_ITM_NM AS SLS_OPPTY_ITM_NM,SIS.SLS_OPPTY_ITM_DN AS SLS_OPPTY_ITM_DN,SIS.SLS_OPPTY_ITM_QT_SCH_IND AS SLS_OPPTY_ITM_QT_SCH_IND,SIS.SLS_OPPTY_ITM_DRCT_IND AS SLS_OPPTY_ITM_DRCT_IND,SIS.SLS_OPPTY_ITM_ATTACH_IND AS SLS_OPPTY_ITM_ATTACH_IND,SIS.SLS_OPPTY_ITM_WIN_BCK_IND AS SLS_OPPTY_ITM_WIN_BCK_IND,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_IND AS SLS_OPPTY_ITM_RTN_TO_SRVC_IND,SIS.SLS_OPPTY_ITM_INTRA_CO_OEM_IND AS SLS_OPPTY_ITM_INTRA_CO_OEM_IND,CAST(SIS.SLS_OPPTY_ITM_REQD_DLVR_TS AS SLS_OPPTY_ITM_REQD_DLVR_DT,CAST(SIS.SLS_OPPTY_ITM_SCH_ESTMT_DLVR_TS AS SLS_OPPTY_ITM_SCH_ESTMT_DLVR_DT,CAST(SIS.SLS_OPPTY_ITM_QTN_TURNRND_TM_GOAL_TS AS SLS_OPPTY_ITM_QTN_TURNRND_TM_GOAL_DT,CAST(SIS.SLS_OPPTY_ITM_SRVCS_STRT_TS AS SLS_OPPTY_ITM_SRVCS_STRT_DT,CAST(SIS.SLS_OPPTY_ITM_SRVCS_END_TS AS SLS_OPPTY_ITM_SRVCS_END_DT,SIS.SLS_OPPTY_ITM_MRGN_PC AS SLS_OPPTY_ITM_MRGN_PC,SIS.SLS_OPPTY_ITM_ENTPRS_QT AS SLS_OPPTY_ITM_ENTPRS_QT,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_QT AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_QT,SIS.SLS_OPPTY_ITM_ENTPRS_LIST_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_SLS_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_TOT_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_MRGN_LC_AM AS SLS_OPPTY_ITM_ENTPRS_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_LC_AM,SIS.SLS_OPPTY_QTD_BILLD_NET_REV_USD_AM AS SLS_OPPTY_QTD_BILLD_NET_REV_USD_AM,SIS.SLS_OPPTY_QTD_GRS_MRGN_USD_AM AS SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.ACCT_HIST_NET_REV_USD_AM AS ACCT_HIST_NET_REV_USD_AM,SIS.ACCT_HIST_GRS_MRGN_USD_AM AS ACCT_HIST_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM AS PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM AS PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM AS PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,SIS.PROJED_SLS_OPPTY_GRS_MRGN_USD_AM AS PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_LIST_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_SLS_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_MRGN_USD_AM AS SLS_OPPTY_ITM_ENTPRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_TOT_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_GRS_MRGN_USD_AM AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_LC_AM AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_LC_AM,SIS.SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_USD_AM AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_USD_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_LC_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_LC_AM,SIS.SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_USD_AM AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_USD_AM,SIS.SRC_SYS_KY AS SRC_SYS_KY,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS INS_GMT_TS AS INS_GMT_TS,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS UPD_GMT_TS AS UPD_GMT_TS,cast({ PARAM_BATCH_ID_s} as BIGINT) AS LOAD_JOB_NR,(CASE WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '1') THEN BAPI.BUS_GRP_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '2') THEN BAPI.GBL_BUS_UNIT_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '3') THEN BAPI.BUS_AREA_CD WHEN (BAPI.BUS_AREA_HIER_LVL_CLS_CD = '4') THEN BAPI.BUS_SUB_AREA_CD ELSE '?' END) AS PROD_MLTGRN_CD,SO.ACT_SOLN_OPPTY_APPV_REVW_ID AS ACT_SOLN_OPPTY_APPV_REVW_ID,ST.SLS_OPPTY_TYPE_CD AS SLS_OPPTY_TYPE_CD,ST.SLS_OPPTY_TYPE_NM AS SLS_OPPTY_TYPE_NM,SDC.SLS_OPPTY_DEAL_CHKLIST_CD AS SLS_OPPTY_DEAL_CHKLIST_CD,SDC.SLS_OPPTY_DEAL_CHKLIST_NM AS SLS_OPPTY_DEAL_CHKLIST_NM,SS.SLS_OPPTY_SLS_STAGE_CD AS SLS_OPPTY_SLS_STAGE_CD,SS.SLS_OPPTY_SLS_STAGE_NM AS SLS_OPPTY_SLS_STAGE_NM,SOFC.SLS_OPPTY_FCST_CATG_CD AS SLS_OPPTY_FCST_CATG_CD,SOFC.SLS_OPPTY_FCST_CATG_NM AS SLS_OPPTY_FCST_CATG_NM,SST.SLS_OPPTY_STAT_CD AS SLS_OPPTY_STAT_CD,SST.SLS_OPPTY_STAT_NM AS SLS_OPPTY_STAT_NM,SR.SLS_OPPTY_RSPY_CD AS SLS_OPPTY_RSPY_CD,SR.SLS_OPPTY_RSPY_NM AS SLS_OPPTY_RSPY_NM,ES.ENTPRS_SOLN_CD AS ENTPRS_SOLN_CD,ES.ENTPRS_SOLN_NM AS ENTPRS_SOLN_NM,(CASE WHEN (TRANSLATE(CT.CNFDTL_TYPE_NM) = 'TRUE') THEN 'Y' WHEN (TRANSLATE(CT.CNFDTL_TYPE_NM) = 'FALSE') THEN 'N' ELSE 'N' END) AS CNFDTL_TYPE_CD,CT.CNFDTL_TYPE_NM AS CNFDTL_TYPE_NM,SPT.SLS_OPPTY_PRCS_TYPE_CD AS SLS_OPPTY_PRCS_TYPE_CD,SPT.SLS_OPPTY_PRCS_TYPE_NM AS SLS_OPPTY_PRCS_TYPE_NM,FT.FIN_SRVC_FIN_TYPE_CD AS FIN_SRVC_FIN_TYPE_CD,FT.FIN_SRVC_FIN_TYPE_NM AS FIN_SRVC_FIN_TYPE_NM,LT.FIN_SRVC_LEASE_TYPE_CD AS FIN_SRVC_LEASE_TYPE_CD,LT.FIN_SRVC_LEASE_TYPE_NM AS FIN_SRVC_LEASE_TYPE_NM,SRT.SLS_OPPTY_RENEW_TYPE_CD AS SLS_OPPTY_RENEW_TYPE_CD,SRT.SLS_OPPTY_RENEW_TYPE_NM AS SLS_OPPTY_RENEW_TYPE_NM,SO.ERLIEST_ESTMT_DLVR_DT AS ERLIEST_ESTMT_DLVR_DT,SO.ERLIEST_SRVCS_STRT_DT AS ERLIEST_SRVCS_STRT_DT,SO.SLS_OPPTY_CLOSE_DT AS SLS_OPPTY_CLOSE_DT,'?' AS CUST_AMID_LVL_2_ID,0 AS SRC_SYS_KY,SIS.SLS_OPPTY_ITM_PROD_MDL_CATG_CD AS SLS_OPPTY_ITM_PROD_MDL_CATG_CD,MDL_CGY.SLS_OPTY_ITM_PROD_MDL_CGY_NM AS SLS_OPPTY_ITM_PROD_MDL_CATG_NM,SIS.SLS_OPPTY_ITM_SCOPE_CD AS SLS_OPPTY_ITM_SCOPE_CD,SCP.SLS_OPTY_ITM_SCP_NM AS SLS_OPPTY_ITM_SCOPE_NM,SIS.BUS_AREA_GRP_ID AS BUS_AREA_GRP_ID, FROM SLS_OPPTY_ITM_AND_SCH_F SIS LEFT OUTER JOIN SLS_OPPTY_ITM_SCH_TYPE_D SIT ON SIS.SPRN_CO_ID = SIT.SPRN_CO_ID AND SIS.SLS_OPPTY_ITM_SCH_TYPE_CD = SIT.SLS_OPPTY_ITM_SCH_TYPE_CD LEFT OUTER JOIN '(select[space]sprn_co_id,[space]bus_area_grp_id,[space]max(BUS_GRP_CD)''BUS_GRP_CD''' max(BUS_AREA_CD) ''BUS_AREA_CD'' 'max(BUS_AREA_HIER_LVL_CLS_CD)''BUS_AREA_HIER_LVL_CLS_CD' FROM BUS_AREA_GRP_ITM_D GROUP BY 1 ON SIS.SPRN_CO_ID = BAPI.SPRN_CO_ID AND SIS.BUS_AREA_GRP_ID = BAPI.BUS_AREA_GRP_ID LEFT OUTER JOIN SLS_OPPTY_F SO ON SIS.SPRN_CO_ID = SO.SPRN_CO_ID AND SIS.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID = SO.SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID LEFT OUTER JOIN SLS_OPPTY_FCST_CATG_D SOFC ON SO.SPRN_CO_ID = SOFC.SPRN_CO_ID AND SO.SLS_OPPTY_FCST_CATG_CD = SOFC.SLS_OPPTY_FCST_CATG_CD LEFT OUTER JOIN SLS_OPPTY_TYPE_D ST ON SO.SPRN_CO_ID = ST.SPRN_CO_ID AND SO.SLS_OPPTY_TYPE_CD = ST.SLS_OPPTY_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_DEAL_CHKLIST_D SDC ON SO.SPRN_CO_ID = SDC.SPRN_CO_ID AND SO.SLS_OPPTY_DEAL_CHKLIST_CD = SDC.SLS_OPPTY_DEAL_CHKLIST_CD LEFT OUTER JOIN SLS_OPPTY_SLS_STAGE_D SS ON SO.SPRN_CO_ID = SS.SPRN_CO_ID AND SO.SLS_OPPTY_SLS_STAGE_CD = SS.SLS_OPPTY_SLS_STAGE_CD LEFT OUTER JOIN SLS_OPPTY_STAT_D SST ON SO.SPRN_CO_ID = SST.SPRN_CO_ID AND SO.SLS_OPPTY_STAT_CD = SST.SLS_OPPTY_STAT_CD LEFT OUTER JOIN SLS_OPPTY_RSPY_D SR ON SO.SPRN_CO_ID = SR.SPRN_CO_ID AND SO.SLS_OPPTY_RSPY_CD = SR.SLS_OPPTY_RSPY_CD LEFT OUTER JOIN ENTPRS_SOLN_D ES ON SO.SPRN_CO_ID = ES.SPRN_CO_ID AND SO.ENTPRS_SOLN_CD = ES.ENTPRS_SOLN_CD LEFT OUTER JOIN CNFDTL_TYPE_D CT ON SO.SPRN_CO_ID = CT.SPRN_CO_ID AND SO.CNFDTL_TYPE_CD = CT.CNFDTL_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_PRCS_TYPE_D SPT ON SO.SPRN_CO_ID = SPT.SPRN_CO_ID AND SO.SLS_OPPTY_PRCS_TYPE_CD = SPT.SLS_OPPTY_PRCS_TYPE_CD LEFT OUTER JOIN FIN_SRVC_FIN_TYPE_D FT ON SO.SPRN_CO_ID = FT.SPRN_CO_ID AND SO.FIN_SRVC_FIN_TYPE_CD = FT.FIN_SRVC_FIN_TYPE_CD LEFT OUTER JOIN FIN_SRVC_LEASE_TYPE_D LT ON SO.SPRN_CO_ID = LT.SPRN_CO_ID AND SO.FIN_SRVC_LEASE_TYPE_CD = LT.FIN_SRVC_LEASE_TYPE_CD LEFT OUTER JOIN SLS_OPPTY_RENEW_TYPE_D SRT ON SO.SPRN_CO_ID = SRT.SPRN_CO_ID AND SO.SLS_OPPTY_RENEW_TYPE_CD = SRT.SLS_OPPTY_RENEW_TYPE_CD LEFT OUTER JOIN SLS_OPTY_ITM_PROD_MDL_CGY MDL_CGY ON SIS.SRC_SYS_KY = MDL_CGY.SRC_SYS_KY AND SIS.SLS_OPPTY_ITM_PROD_MDL_CATG_CD = MDL_CGY.SLS_OPTY_ITM_PROD_MDL_CGY_CD AND MDL_CGY.DLT_IND = 'N' LEFT OUTER JOIN SLS_OPTY_ITM_SCP SCP ON SIS.SRC_SYS_KY = SCP.SRC_SYS_KY AND SIS.SLS_OPPTY_ITM_SCOPE_CD = SCP.SLS_OPTY_ITM_SCP_CD AND SCP.DLT_IND = 'N';""".format(PARAM_BATCH_ID_s=PARAM_BATCH_ID_s, PARAM_BATCH_GMT_START_TS_s=PARAM_BATCH_GMT_START_TS_s)
    ret_val = execute_sql("3", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(3)

    PARAM_BATCH_ID_s = fetch_param_value("5", spark_session, "PARAM_BATCH_ID_s")
    if PARAM_BATCH_ID_s is None:
        print("ERROR fetching value for parameter 'PARAM_BATCH_ID_s'")
        sys.exit(4)
    PARAM_BATCH_GMT_START_TS_s = fetch_param_value("5", spark_session, "PARAM_BATCH_GMT_START_TS_s")
    if PARAM_BATCH_GMT_START_TS_s is None:
        print("ERROR fetching value for parameter 'PARAM_BATCH_GMT_START_TS_s'")
        sys.exit(4)
        #INSERT INTO SLS_OPPTY_ITM_AND_SCH_COMBINED_F SELECT '1' AS SPRN_CO_ID,OER.OPPTY_ID AS SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID,OER.REV_LN_ITM_ID AS SLS_OPPTY_ITM_NR,'?' AS SLS_OPPTY_ITM_SCH_ITM_NR,0 AS SLS_OPPTY_ID,0 AS BUS_AREA_GRP_ID,'?' AS SLS_OPPTY_ITM_SCH_TYPE_CD,'N/V' AS SLS_OPPTY_ITM_SCH_TYPE_NM,nvl(OER.RANDOM_DEAL_ID,'?') AS RANDOM_DEAL_ID,nvl(OER.DSTNCT_DEAL_CT_NR,0) AS DSTNCT_DEAL_CT_NR,nvl(OER.OPPTY_QTD_MRGN_FAC_NR,0) AS SLS_OPPTY_QTD_MRGN_FAC_NR,nvl(OER.ACCT_HIST_MRGN_FAC_NR,0) AS ACCT_HIST_MRGN_FAC_NR,nvl(OER.CTRY_PROXY_MRGN_FAC_NR,0) AS TRY_PROXY_MRGN_FAC_NR,nvl(OER.PROJED_OPPTY_MRGN_FAC_NR,0) AS PROJED_SLS_OPPTY_MRGN_FAC_NR,nvl(OER.CRNCY_CD,'?') AS CRNCY_CD,nvl(OER.QTD_MRGN_FAC_PROD_LVL_CD, '?'),nvl(OER.QTD_MRGN_FAC_PROD_LVL_EXT_CD, '?'),nvl(OER.ACCT_HIST_MRGN_FAC_PROD_LVL_CD, '?'),nvl(OER.ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD,'?'),nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD, '?'),nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_LVL_CD, '?'),nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD, '?'),nvl(OER.PROJED_OPPTY_MRGN_FAC_PROD_LVL_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_CD,nvl(OER.PROJED_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD,nvl(OER.PROJED_OPPTY_MRGN_FAC_SRC_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_SRC_CD,'N/V' AS SLS_OPPTY_ITM_NM,nvl(OER.REV_TX, '?') AS SLS_OPPTY_ITM_DN,'?' AS SLS_OPPTY_ITM_QT_SCH_IND,'?' AS SLS_OPPTY_ITM_DRCT_IND,'?' AS SLS_OPPTY_ITM_ATTACH_IND,'?' AS SLS_OPPTY_ITM_WIN_BCK_IND,'?' AS SLS_OPPTY_ITM_RTN_TO_SRVC_IND,'?' AS SLS_OPPTY_ITM_INTRA_CO_OEM_IND,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_REQD_DLVR_DT,OER.EXPT_SHIP_BOOK_DT AS SLS_OPPTY_ITM_SCH_ESTMT_DLVR_DT,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_QTN_TURNRND_TM_GOAL_DT,OER.SRVCS_STRT_DT AS SLS_OPPTY_ITM_SRVCS_STRT_DT,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_SRVCS_END_DT,0 AS SLS_OPPTY_ITM_MRGN_PC,nvl(OER.PROD_SRVC_QT,0) AS SLS_OPPTY_ITM_ENTPRS_QT,nvl(OER.HPFS_PROD_SRVC_QT,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_QT,0 AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_LC_AM,nvl(OER.UNIT_PRC_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_LC_AM,nvl(OER.HPFS_UNIT_PRC_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_LC_AM,nvl(OER.ESTMT_FCST_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_LC_AM,nvl(OER.HPFS_ESTMT_FCST_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_MRGN_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_LC_AM,nvl(OER.FRST_FISC_YR_OPPTY_ESTMT_REV_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_LC_AM,nvl(OER.FRST_YR_TOT_OPPTY_ESTMT_REV_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_LC_AM,nvl(OER.OPPTY_QTD_BDNET_REV_USD_AM,0) AS SLS_OPPTY_QTD_BILLD_NET_REV_USD_AM,nvl(OER.OPPTY_QTD_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.ACCT_HIST_NET_REV_USD_AM,0) AS ACCT_HIST_NET_REV_USD_AM,nvl(OER.ACCT_HIST_GRS_MRGN_USD_AM,0) AS ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_QTD_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_USD_AM,nvl(OER.UNIT_PRC_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_USD_AM,nvl(OER.HPFS_UNIT_PRC_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_USD_AM,nvl(OER.EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_MRGN_USD_AM,nvl(OER.HPFS_EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_USD_AM,nvl(OER.FRST_FISC_YR_OPPTY_ESTMT_REV_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_USD_AM,nvl(OER.FRST_YR_TOT_OPPTY_ESTMT_REV_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_USD_AM,nvl(OER.ESTMT_FCST_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_USD_AM,nvl(OER.HPFS_ESTMT_FCST_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_USD_AM,nvl(OER.PROJED_OPPTY_QTD_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_LC_AM,0 AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_LC_AM,nvl(OER.FRST_FISC_YR_OPPTY_EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_USD_AM,114 AS SRC_SYS_KY,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS INS_GMT_TS,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS UPD_GMT_TS,{PARAM_BATCH_ID_s} AS LOAD_JOB_NR,OER.PROD_MLTGRN_CD AS PROD_MLTGRN_CD,NVL(OA.ACT_SOLN_OPPTY_APPV_REVW_ID,0) AS ACT_SOLN_OPPTY_APPV_REVW_ID,'?' AS SLS_OPPTY_TYPE_CD,OA.OPPTY_TYPE_CD AS SLS_OPPTY_TYPE_NM,'?' AS SLS_OPPTY_DEAL_CHKLIST_CD,'N/V' AS SLS_OPPTY_DEAL_CHKLIST_NM,'?' AS SLS_OPPTY_SLS_STAGE_CD,(CASE WHEN (OA.SLS_STAGE_CD IN ('06 - Won & Deploy', '07 - Won & Expand')) THEN '06 - Won, Deploy & Expand' WHEN (OA.SLS_STAGE_CD = 'Not Pursued') THEN 'HP Not Pursued' ELSE OA.SLS_STAGE_CD END) AS SLS_OPPTY_SLS_STAGE_NM,'?' AS SLS_OPPTY_FCST_CATG_CD,(CASE WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.COMMT_IND_CD = 'Y') THEN 'Commit' WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.UPSD_IND_CD = 'Y') THEN 'Upside' WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.COMMT_IND_CD = 'N' AND OA.UPSD_IND_CD = 'N') THEN 'Pipeline' WHEN (UPPER(OA.OPPTY_STAT_CD) = 'WON') THEN 'Won' WHEN (UPPER(OA.OPPTY_STAT_CD) IN ('LOST', 'CANCELLED')) THEN 'Omitted' ELSE 'N/V' END) AS SLS_OPPTY_FCST_CATG_NM,'?' AS SLS_OPPTY_STAT_CD,OA.OPPTY_STAT_CD AS SLS_OPPTY_STAT_NM,'?' AS SLS_OPPTY_RSPY_CD,(CASE WHEN (OA.MNG_BY_CD = 'Partner') THEN 'Partner' WHEN ((OA.MNG_BY_CD IN ('?', 'DEFAULT_VALUE', 'HPFS') OR OA.MNG_BY_CD IS NULL)) THEN NULL ELSE 'HP' END) AS SLS_OPPTY_RSPY_NM,'?' AS ENTPRS_SOLN_CD,'N/V' AS ENTPRS_SOLN_NM,NVL(OA.PUB_SECTOR_SEC_FG,'?') AS CNFDTL_TYPE_CD,'N/V' AS CNFDTL_TYPE_NM,'?' AS SLS_OPPTY_PRCS_TYPE_CD,(CASE WHEN (UPPER(OA.MNG_BY_CD) = 'HPFS') THEN 'HPFS' ELSE 'Standard' END) AS SLS_OPPTY_PRCS_TYPE_NM,'?' AS FIN_SRVC_FIN_TYPE_CD,NVL(OA.FIN_TYPE_CD,'?') AS FIN_SRVC_FIN_TYPE_NM,'?' AS FIN_SRVC_LEASE_TYPE_CD,NVL(OA.LEASE_TYPE_CD,'?') AS FIN_SRVC_LEASE_TYPE_NM,'?' AS SLS_OPPTY_RENEW_TYPE_CD,'N/V' AS SLS_OPPTY_RENEW_TYPE_NM,NVL(OA.ERLIEST_EXPT_BOOK_SHIP_DT,TO_DATE('1900-01-01')) AS ERLIEST_ESTMT_DLVR_DT,OA.ERLIEST_SRVCS_STRT_DT AS ERLIEST_SRVCS_STRT_DT,OA.CLOSE_DT AS SLS_OPPTY_CLOSE_DT,'?' AS SLS_OPPTY_ITM_PROD_MDL_CATG_CD,'N/V' AS SLS_OPPTY_ITM_PROD_MDL_CATG_NM,'?' AS SLS_OPPTY_ITM_SCOPE_CD,'N/V' AS SLS_OPPTY_ITM_SCOPE_NM FROM OPPTY_ESTMT_REV_A_F OER LEFT OUTER JOIN OPPTY_A_D OA ON OER.OPPTY_ID = OA.OPPTY_ID WHERE OA.SLS_MTHD_CD = 'Sales Methodology' AND (OA.GBL_OPPTY_CD <> 'HOST' OR OA.GBL_OPPTY_CD IS NULL) AND OA.OPPTY_ID NOT LIKE 'OPP%%'
    query_to_execute = """INSERT INTO SLS_OPPTY_ITM_AND_SCH_COMBINED_F SELECT '1' AS SPRN_CO_ID,OER.OPPTY_ID AS SLS_OPPTY_SRC_OPPTY_SHT_UNQ_ID,OER.REV_LN_ITM_ID AS SLS_OPPTY_ITM_NR,'?' AS SLS_OPPTY_ITM_SCH_ITM_NR,0 AS SLS_OPPTY_ID,0 AS BUS_AREA_GRP_ID,'?' AS SLS_OPPTY_ITM_SCH_TYPE_CD,TRANSLATE('N/V') AS SLS_OPPTY_ITM_SCH_TYPE_NM,nvl(OER.RANDOM_DEAL_ID,'?') AS RANDOM_DEAL_ID,nvl(OER.DSTNCT_DEAL_CT_NR,0) AS DSTNCT_DEAL_CT_NR,nvl(OER.OPPTY_QTD_MRGN_FAC_NR,0) AS SLS_OPPTY_QTD_MRGN_FAC_NR,nvl(OER.ACCT_HIST_MRGN_FAC_NR,0) AS ACCT_HIST_MRGN_FAC_NR,nvl(OER.CTRY_PROXY_MRGN_FAC_NR,0) AS CTRY_PROXY_MRGN_FAC_NR,nvl(OER.PROJED_OPPTY_MRGN_FAC_NR,0) AS PROJED_SLS_OPPTY_MRGN_FAC_NR,nvl(OER.CRNCY_CD,'?') AS CRNCY_CD,nvl(OER.QTD_MRGN_FAC_PROD_LVL_CD, '?') AS QTD_MRGN_FAC_PROD_LVL_CD,nvl(OER.QTD_MRGN_FAC_PROD_LVL_EXT_CD, '?') AS QTD_MRGN_FAC_PROD_LVL_EXT_CD,nvl(OER.ACCT_HIST_MRGN_FAC_PROD_LVL_CD, '?') AS ACCT_HIST_MRGN_FAC_PROD_LVL_CD,nvl(OER.ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD,'?') AS ACCT_HIST_MRGN_FAC_PROD_LVL_EXT_CD,nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD, '?') AS CTRY_PROXY_MRGN_FAC_PROD_MLTGRN_CD,nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_LVL_CD, '?') AS CTRY_PROXY_MRGN_FAC_PROD_LVL_CD,nvl(OER.CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD, '?') AS CTRY_PROXY_MRGN_FAC_PROD_LVL_EXT_CD,nvl(OER.PROJED_OPPTY_MRGN_FAC_PROD_LVL_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_CD,nvl(OER.PROJED_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_PROD_LVL_EXT_CD,nvl(OER.PROJED_OPPTY_MRGN_FAC_SRC_CD, '?') AS PROJED_SLS_OPPTY_MRGN_FAC_SRC_CD,TRANSLATE('N/V') AS SLS_OPPTY_ITM_NM,nvl(OER.REV_TX, '?') AS SLS_OPPTY_ITM_DN,'?' AS SLS_OPPTY_ITM_QT_SCH_IND,'?' AS SLS_OPPTY_ITM_DRCT_IND,'?' AS SLS_OPPTY_ITM_ATTACH_IND,'?' AS SLS_OPPTY_ITM_WIN_BCK_IND,'?' AS SLS_OPPTY_ITM_RTN_TO_SRVC_IND,'?' AS SLS_OPPTY_ITM_INTRA_CO_OEM_IND,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_REQD_DLVR_DT,OER.EXPT_SHIP_BOOK_DT AS SLS_OPPTY_ITM_SCH_ESTMT_DLVR_DT,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_QTN_TURNRND_TM_GOAL_DT,OER.SRVCS_STRT_DT AS SLS_OPPTY_ITM_SRVCS_STRT_DT,TO_DATE('1900-01-01') AS SLS_OPPTY_ITM_SRVCS_END_DT,0 AS SLS_OPPTY_ITM_MRGN_PC,nvl(OER.PROD_SRVC_QT,0) AS SLS_OPPTY_ITM_ENTPRS_QT,nvl(OER.HPFS_PROD_SRVC_QT,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_QT,0 AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_LC_AM,nvl(OER.UNIT_PRC_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_LC_AM,nvl(OER.HPFS_UNIT_PRC_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_LC_AM,nvl(OER.ESTMT_FCST_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_LC_AM,nvl(OER.HPFS_ESTMT_FCST_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_MRGN_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_LC_AM,nvl(OER.FRST_FISC_YR_OPPTY_ESTMT_REV_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_LC_AM,nvl(OER.FRST_YR_TOT_OPPTY_ESTMT_REV_VALU_LCL_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_LC_AM,nvl(OER.OPPTY_QTD_BDNET_REV_USD_AM,0) AS SLS_OPPTY_QTD_BILLD_NET_REV_USD_AM,nvl(OER.OPPTY_QTD_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.ACCT_HIST_NET_REV_USD_AM,0) AS ACCT_HIST_NET_REV_USD_AM,nvl(OER.ACCT_HIST_GRS_MRGN_USD_AM,0) AS ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_QTD_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_GRS_MRGN_USD_AM,0) AS PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_LIST_PRC_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_LIST_PRC_USD_AM,nvl(OER.UNIT_PRC_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_SLS_PRC_USD_AM,nvl(OER.HPFS_UNIT_PRC_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_SLS_PRC_USD_AM,nvl(OER.EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_MRGN_USD_AM,nvl(OER.HPFS_EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_MRGN_USD_AM,nvl(OER.FRST_FISC_YR_OPPTY_ESTMT_REV_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_ESTMT_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_ESTMT_USD_AM,nvl(OER.FRST_YR_TOT_OPPTY_ESTMT_REV_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_CLDR_YR_ESTMT_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_CLDR_YR_ESTMT_USD_AM,nvl(OER.ESTMT_FCST_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_TOT_PRC_USD_AM,nvl(OER.HPFS_ESTMT_FCST_VALU_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_TOT_PRC_USD_AM,nvl(OER.PROJED_OPPTY_QTD_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_QTD_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_ACCT_HIST_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_CTRY_PROXY_GRS_MRGN_USD_AM,nvl(OER.PROJED_OPPTY_GRS_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_SCH_PROJED_SLS_OPPTY_GRS_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_LC_AM,0 AS SLS_OPPTY_ITM_RTN_TO_SRVC_VALU_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_LC_AM,nvl(OER.FRST_FISC_YR_OPPTY_EXPT_MRGN_USD_AM,0) AS SLS_OPPTY_ITM_ENTPRS_FRST_FISC_YR_MRGN_USD_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_LC_AM,0 AS SLS_OPPTY_ITM_ENTPRS_FIN_SRVC_FRST_FISC_YR_MRGN_USD_AM,114 AS SRC_SYS_KY,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS INS_GMT_TS AS INS_GMT_TS,CAST('{PARAM_BATCH_GMT_START_TS_s}' AS TIMESTAMP)AS UPD_GMT_TS AS UPD_GMT_TS,cast({ PARAM_BATCH_ID_s} as BIGINT) AS LOAD_JOB_NR,OER.PROD_MLTGRN_CD AS PROD_MLTGRN_CD,NVL(OA.ACT_SOLN_OPPTY_APPV_REVW_ID,0) AS ACT_SOLN_OPPTY_APPV_REVW_ID,'?' AS SLS_OPPTY_TYPE_CD,TRANSLATE(OA.OPPTY_TYPE_CD) AS SLS_OPPTY_TYPE_NM,'?' AS SLS_OPPTY_DEAL_CHKLIST_CD,TRANSLATE('N/V') AS SLS_OPPTY_DEAL_CHKLIST_NM,'?' AS SLS_OPPTY_SLS_STAGE_CD,(CASE WHEN (OA.SLS_STAGE_CD IN ('06[space]-[space]Won[space]&[space]Deploy', '07[space]-[space]Won[space]&[space]Expand')) THEN TRANSLATE('06[space]-[space]Won,[space]Deploy[space]&[space]Expand') WHEN (OA.SLS_STAGE_CD = 'Not[space]Pursued') THEN TRANSLATE('HP[space]Not[space]Pursued') ELSE TRANSLATE(OA.SLS_STAGE_CD) END) AS SLS_OPPTY_SLS_STAGE_NM,'?' AS SLS_OPPTY_FCST_CATG_CD,(CASE WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.COMMT_IND_CD = 'Y') THEN TRANSLATE('Commit') WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.UPSD_IND_CD = 'Y') THEN TRANSLATE('Upside') WHEN (UPPER(OA.OPPTY_STAT_CD) = 'OPEN' AND OA.COMMT_IND_CD = 'N' AND OA.UPSD_IND_CD = 'N') THEN TRANSLATE('Pipeline') WHEN (UPPER(OA.OPPTY_STAT_CD) = 'WON') THEN TRANSLATE('Won') WHEN (UPPER(OA.OPPTY_STAT_CD) IN ('LOST', 'CANCELLED')) THEN TRANSLATE('Omitted') ELSE TRANSLATE('N/V') END) AS SLS_OPPTY_FCST_CATG_NM,'?' AS SLS_OPPTY_STAT_CD,TRANSLATE(OA.OPPTY_STAT_CD) AS SLS_OPPTY_STAT_NM,'?' AS SLS_OPPTY_RSPY_CD,(CASE WHEN (OA.MNG_BY_CD = 'Partner') THEN _UNICODE2('Partner') WHEN ((OA.MNG_BY_CD IN ('?', 'DEFAULT_VALUE', 'HPFS') OR OA.MNG_BY_CD IS NULL)) THEN NULL ELSE _UNICODE2('HP') END) AS SLS_OPPTY_RSPY_NM,'?' AS ENTPRS_SOLN_CD,TRANSLATE('N/V') AS ENTPRS_SOLN_NM,NVL(OA.PUB_SECTOR_SEC_FG,'?') AS CNFDTL_TYPE_CD,TRANSLATE('N/V') AS CNFDTL_TYPE_NM,'?' AS SLS_OPPTY_PRCS_TYPE_CD,(CASE WHEN (UPPER(OA.MNG_BY_CD) = 'HPFS') THEN TRANSLATE('HPFS') ELSE TRANSLATE('Standard') END) AS SLS_OPPTY_PRCS_TYPE_NM,'?' AS FIN_SRVC_FIN_TYPE_CD,NVL(OA.FIN_TYPE_CD,'?') AS FIN_SRVC_FIN_TYPE_NM,'?' AS FIN_SRVC_LEASE_TYPE_CD,NVL(OA.LEASE_TYPE_CD,'?') AS FIN_SRVC_LEASE_TYPE_NM,'?' AS SLS_OPPTY_RENEW_TYPE_CD,TRANSLATE('N/V') AS SLS_OPPTY_RENEW_TYPE_NM,NVL(OA.ERLIEST_EXPT_BOOK_SHIP_DT,TO_DATE('1900-01-01')) AS ERLIEST_ESTMT_DLVR_DT,OA.ERLIEST_SRVCS_STRT_DT AS ERLIEST_SRVCS_STRT_DT,OA.CLOSE_DT AS SLS_OPPTY_CLOSE_DT,'?' AS SLS_OPPTY_ITM_PROD_MDL_CATG_CD,_UNICODE2('N/V') AS SLS_OPPTY_ITM_PROD_MDL_CATG_NM,'?' AS SLS_OPPTY_ITM_SCOPE_CD,_UNICODE2('N/V') AS SLS_OPPTY_ITM_SCOPE_NM FROM OPPTY_ESTMT_REV_A_F OER LEFT OUTER JOIN OPPTY_A_D OA ON OER.OPPTY_ID = OA.OPPTY_ID WHERE OA.SLS_MTHD_CD = 'Sales[space]Methodology' AND (OA.GBL_OPPTY_CD <> 'HOST' OR OA.GBL_OPPTY_CD IS NULL) AND OA.OPPTY_ID NOT LIKE 'OPP%%'
 ;""".format(PARAM_BATCH_ID_s=PARAM_BATCH_ID_s, PARAM_BATCH_GMT_START_TS_s=PARAM_BATCH_GMT_START_TS_s)
    ret_val = execute_sql("4", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(4)

    query_to_execute = """/* PARAM_SM_SPT_UPDATE_TABLE_s FOR TABLE SLS_OPPTY_ITM_AND_SCH_COMBINED_F ON EVERY COLUMN SAMPLE; */ SELECT 1;""" 
    ret_val = execute_sql("5", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(5)


    spark_session.stop()


if __name__ == "__main__":
    # datetime object containing current date and time
    now = datetime.now()
     
    # dd/mm/YY H:M:S
    dt_string = now.strftime("%Y/%m/%d %H:%M:%S")
    file_name =  os.path.basename(sys.argv[0])
    print("{} | {} | starting execution".format(dt_string, file_name))
    
    execute()
    
    dt_string = now.strftime("%Y/%m/%d %H:%M:%S")
    
    print("{} | {} | done".format(dt_string, file_name))

#
# end
#
